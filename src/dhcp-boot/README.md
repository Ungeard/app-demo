DHCP-Boot application, download WeOS configuration from application
===================================================================

Introduction
-------------

The `dhcp-boot` application is an example of how a container application could
create or alter a configuration file. In a real world scenario a non native configuration file
could be converted to OS native format. 
In this simple example the application only changes the hostname to verify that the 
configuration has been received from the application. The host will download
the file from th application using TFTP and use it as a new running config:

```
Host            #  Dhcp-boot Application
                #  .-------------.  .-------------.
                #  | DHCP-server |  | TFTP-server |
                #  '------+------'  '------+------'
.------------.  #         '------.  .------'
|    cfg     |  #              .-+--+-.
| inet: dhcp |  #              | eth0 |
'------+-----'  #              '--+---'
       |        #                 |
       '--------------------------'
```


A simple configuration file is read and the hostname is changed by the application.
The application container will be connected to the host via a VETH pair, cfg/eth0.
The host will download the converted configuration file using TFTP and use it as
a new running-config.

Configuration
-------------

### Prepare External Media

It is important that the USB media is formatted as ext2, ext3 or ext4. We also
need to create four files on the USB media:

- `dnsmasq.conf`: Configuration for [Dnsmasq][dnsmasq], which will serve as
  both DHCP server and TFTP server in the container.
- `cfg-provider.sh`: A script that will serve as an entry point for the
  container. Any modification could be instrumented from here. Responsible
  for starting Dnsmasq.
- `config.cfg`: The config that the application creates and the Dnsmasq will serve.
  It must be consistent with what is set as DHCP option 67 in Dnsmasq.
- `config/net-config.cfg`: The bootstrap config that will carry the
  configuration for our application container.

Prepare the USB media by creating the first two files:

**dnsmasq.conf**
```
log-facility=-
no-daemon

enable-tftp
tftp-root=/mnt

interface=eth0
dhcp-option=66,"10.0.0.1"
dhcp-option=67,"config.cfg"

dhcp-range=tag:eth0,10.0.0.2,10.0.0.3,1h
```

**cfg-provider.sh**
```
#!/bin/sh

# Set up the default interface
ip link set dev eth0 up
ip addr add 10.0.0.1/30 dev eth0

# Start our DHCP/TFTP server Dnsmasq
exec dnsmasq -C /etc/dnsmasq.conf
```

**Note** `cfg-provider.sh` needs to have the executable bit set.

### pre-config.cfg
Configuration file containing a hostname.
E.g.
{
  .
  .
  "system": {
    "hostname": "Host",
    .
    .
    .
  },
  .
  .
}

### config.cfg

In our example `config.cfg` is generated by the application by
altering the hostname in the pre-config.cfg.

The file should look something like this after the conversion.

```
{
  .
  .
  "system": {
    "hostname": "Host_name_from_app",
    .
    .
    .
  },
  .
  .
}
```

After reboot the container application starts up, the host fetches the new
running-config from the container, and that config is applied, resulting in
the `hostname` changing to "Host_name_from_app".

### creation of config/net-config.cfg
net-config will be stored on USB media.

Configure the app that will host/run the files we have created:

<pre class="cli-example">
example:/#> configure app cfg dhcp-boot
example:/config/app-cfg/#> share path /usb/cfg-provider.sh as /bin/cfg-provider.sh create
example:/config/app-cfg/#> share path /usb/dnsmasq.conf as /etc/dnsmasq.conf create
example:/config/app-cfg/#> share path /usb as /mnt
example:/config/app-cfg/#> end
</pre>

Along with the app, a VETH pair is created. By default it will have the same name as the
app on the host side, and `eth0` on the container side. 
We need to configure DHCP for the host side interface:

<pre class="cli-example">
example:/config/#> iface cfg
example:/config/iface-cfg/#> inet dhcp
example:/config/iface-cfg/inet-dhcp/#> option 66, 67
example:/config/iface-cfg/inet-dhcp/#> leave
</pre>

The net-config is now complete. Copy it to the external media and reset the
running-config:

<pre class="cli-example">
example:/#> copy running-config usb://config/net-config.cfg
Copying running-config to /usb/config/net-config.cfg ...
example:/#> Done.
</pre>

### Creation of pre-config.cfg
pre-config will be stored on USB media. Simply change the hostname to Host.

<pre class="cli-example">
example:/#> configure system
example:/config/system/#> hostname Host
example:/config/system/#> leave
Applying configuration.
Configuration activated.  Remember "copy run start" to save to flash (NVRAM).
Host:/#> cp running-config usb://pre-config.cfg
Copying running-config to /usb/pre-config.cfg ...
Done.
Host:/#> copy factory-config running-config
Applying configuration.
</pre>

Finally we configure our system to use net-config on external media to boot
the system, and reboot:
	
<pre class="cli-example">
example:/#> boot
example:/boot/#> config-order ext:net
example:/boot/#> leave
example:/#> reboot
</pre>

After reboot the container application starts and changed the hostname "Host" to
"Host_name_from_app" and saves the new configuration in usb/config.cfg. The host fetches 
and applies the new running-config from the container, resulting in the `hostname` being changed.
